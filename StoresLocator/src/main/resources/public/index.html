<!DOCTYPE html>
<html>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
<body>

<p id="demo">Click the button to get your coordinates.</p>

<button onclick="getLocation()">Find stores close to you!</button><br><br>

<div id="mapholder"></div>

<script src="https://maps.google.com/maps/api/js?key=AIzaSyB7DbK4YiBq8UHWkziKsTplVMuNbtszQ44"></script>

<script>
var x = document.getElementById("demo");
var map;
var bounds = new google.maps.LatLngBounds();

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
        navigator.geolocation.getCurrentPosition(showResult);
    } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
    }
}

function showPosition(position) {
    //x.innerHTML = "Latitude: " + position.coords.latitude +
    //"<br>Longitude: " + position.coords.longitude;

    var lat = position.coords.latitude;
    var lon = position.coords.longitude;
    $("body").append("<br>Your position is:")
    $("body").append("<br>Latitude: "+lat)
    $("body").append(" Longitude: "+lon+"<br>")
    var latlon = new google.maps.LatLng(lat, lon)
    var mapholder = document.getElementById('mapholder')
    mapholder.style.height = '250px';
    mapholder.style.width = '500px';

    var myOptions = {
    center:latlon,zoom:14,
    mapTypeId:google.maps.MapTypeId.ROADMAP,
    mapTypeControl:false,
    navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}
    }

    map = new google.maps.Map(document.getElementById("mapholder"), myOptions);
    var marker = new google.maps.Marker({position:latlon,map:map,title:"You are here!"});
    marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png')
    bounds.extend(marker.position);
    $("body").append("<br>")
}

function showError(error) {
    switch(error.code) {
        case error.PERMISSION_DENIED:
            x.innerHTML = "User denied the request for Geolocation."
            break;
        case error.POSITION_UNAVAILABLE:
            x.innerHTML = "Location information is unavailable."
            break;
        case error.TIMEOUT:
            x.innerHTML = "The request to get user location timed out."
            break;
        case error.UNKNOWN_ERROR:
            x.innerHTML = "An unknown error occurred."
            break;
    }
}

function showResult(position)
{
        var lat = position.coords.latitude;
        var lon = position.coords.longitude;

		$.get("./stores/"+lat+"/"+lon, function (resultData) {
		window.foundStores = resultData;
		$("body").append("<div>The closest stores to your position are:</div>")
		$("body").append("<br>")
		for (var i = 0; i < resultData.length; i++) {
            $("body").append("<div>Store "+(i+1)+":")
            var distance = parseFloat(JSON.stringify(resultData[i].distanceToStore))
            $("body").append("Distance to store: "+ ((distance<1000)?distance+" meters":(distance/1000)+" km"))
            $("body").append("<br>Store name: "+JSON.stringify(resultData[i].store.addressName))
            $("body").append("<br><br></div>")

            latlon = new google.maps.LatLng(resultData[i].store.latitude, resultData[i].store.longitude)
            marker = new google.maps.Marker({position:latlon,map:map,title:resultData[i].store.addressName});
            marker.setIcon('http://maps.google.com/mapfiles/ms/icons/blue-dot.png')
            bounds.extend(marker.position);
            marker.setMap(map);
            map.fitBounds(bounds);
		}
		});
}
</script>
</body>
</html>
